<template>
  <div class="text-left">
    <h1 class="font-weight-black text-h4 my-4">Cr√©er des cantines via CSV</h1>
    <p>
      Vous g√©rez plus que dix cantines, ou vous avez d√©j√† vos donn√©es en format tableur num√©rique ? Utilisez notre outil
      d'import pour ajouter vos cantines en deux √©tapes !
    </p>
    <p>
      Sinon, utilisez notre
      <router-link :to="{ name: 'NewCanteen' }">formulaire pour ajouter une nouvelle cantine</router-link>
      pour une experience plus guid√©.
    </p>

    <h2 class="my-4">1. Preparer le fichier</h2>

    <p>
      Suivant le niveau d'information disponible, vous pouvez choisir entre ces deux types d'import. √Ä terme, pour
      t√©l√©d√©clarer vos donn√©es, seule le diagnostic complet sera accept√©.
    </p>
    <v-radio-group v-model="diagnosticType">
      <v-radio v-for="type in diagnosticTypes" :key="type.key" :label="type.label" :value="type.key">
        <template v-slot:label>
          <span class="grey--text text--darken-3 font-weight-bold">{{ type.label }}</span>
          <span class="body-2 ml-3">{{ type.help }}</span>
        </template>
      </v-radio>
    </v-radio-group>
    <p>
      <a href="#documentation">
        Voir les donn√©es requises pour
        <b>{{ importDocString }}</b>
        .
      </a>
    </p>
    <p>
      Vous pouvez √©galement t√©l√©charger un fichier exemple en format de choix :
      <a class="text-decoration-underline" :href="`${exampleFilename}.csv`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        CSV (.csv)
      </a>
      <a class="text-decoration-underline" :href="`${exampleFilename}.xlsx`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        Excel (.xlsx)
      </a>
      <a class="text-decoration-underline" :href="`${exampleFilename}.ods`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        OpenDocument (.ods)
      </a>
      .
    </p>

    <v-alert v-if="isStaff" outlined type="info" class="body-2 blue--text text--darken-2">
      En tant que membre de l'√©quipe ma cantine, vous pouvez ajoter trois colonnes additionnelles √† la fin du fichier
      CSV :
      <br />
      <ul>
        <li>Une liste d'adresses email de gestionnaires qui seront ajout√©s sans √™tre notifi√©s par email, et</li>
        <li>Un identifiant d√©crivant la source de donn√©es</li>
        <li>
          Optionnel : Un √©tat de publication (les options sont
          <code>published</code>
          ,
          <code>pending</code>
          , ou
          <code>draft</code>
          )
        </li>
      </ul>
      T√©l√©chargez l'en-t√™te en format :
      <a class="text-decoration-underline" href="/static/documents/fichier_exemple_staff.xlsx" download>
        Excel (.xlsx)
      </a>
      ,
      <a class="text-decoration-underline" href="/static/documents/fichier_exemple_staff.csv" download>
        CSV
      </a>
      ,
      <a class="text-decoration-underline" href="/static/documents/fichier_exemple_staff.ods" download>
        OpenDocument (.ods)
      </a>
      <br />
      √Ä noter que vous ne serez pas ajout√©.e.s automatiquement √† l'√©quipe de gestion sauf si votre mail se trouve dans
      une des colonnes de listes de gestionnaires.
      <br />
      Bon courage ! üëæ üöÄ
    </v-alert>

    <h2 class="mt-8">2. Transf√®rer le fichier</h2>
    <v-row>
      <v-col cols="4" class="py-10">
        <label>Confirmer le niveau d'import :</label>
        <v-radio-group v-model="diagnosticType" class="ml-4">
          <v-radio v-for="type in diagnosticTypes" :key="type.key" :label="type.label" :value="type.key">
            <template v-slot:label>
              <span class="grey--text text--darken-3">{{ type.label }}</span>
            </template>
          </v-radio>
        </v-radio-group>
      </v-col>
      <v-col>
        <FileDrop
          v-model="file"
          subtitle="Format CSV encod√© en UTF-8 attendu"
          :acceptTypes="['.csv', 'text/csv', '.tsv', 'text/tsv']"
          maxSize="10485760"
          @upload="upload"
          :disabled="importInProgress"
        />
      </v-col>
    </v-row>

    <v-card outlined class="pa-4" v-if="importInProgress">
      <v-progress-circular indeterminate color="primary" size="28" class="mr-4"></v-progress-circular>
      <span class="mt-1">Traitement en cours...</span>
    </v-card>
    <div v-if="!isNaN(canteenCount) && !importInProgress">
      <!-- TODO: maybe just redirect to mes cantines on success ? -->
      <div v-if="canteenCount > 0">
        <v-alert type="success" outlined>
          <span class="grey--text text--darken-4 body-2">
            {{ canteenCount }} cantines
            <span v-if="diagnosticCount">et {{ diagnosticCount }} diagnostics&nbsp;</span>
            <span>ont √©t√© {{ diagnosticCount ? "trait√©s" : "trait√©es" }}.</span>
          </span>
        </v-alert>
        <router-link :to="{ name: 'ManagementPage' }" class="ma-4">‚Üê Retourner √† mes cantines</router-link>
      </div>
      <div v-if="errors && errors.length">
        <h2 class="my-4">3. Adresser les erreurs suivants, et re-essayer</h2>
        <p class="text-body-2 red--text text--darken-4" v-if="canteenCount === 0">
          Nous n'avons pas pu traiter votre fichier. Vous trouverez ci-dessous des informations sur les erreurs
          rencontr√©es.
        </p>
        <p class="text-body-2">
          Revoir
          <a href="#documentation">notre documentation</a>
          pour repondre aux questions les plus fr√©quentes, ou
          <a href="#contact">contactez-nous</a>
          pour plus d'aide.
        </p>
        <v-alert type="error" outlined>
          <v-simple-table color="red darken-2" dense>
            <template v-slot:default>
              <thead>
                <tr>
                  <th>Ligne</th>
                  <th>Erreur</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="error in errors" :key="error.row">
                  <td>{{ error.row }}</td>
                  <td>{{ error.message }}</td>
                </tr>
              </tbody>
            </template>
          </v-simple-table>
        </v-alert>
      </div>
    </div>

    <v-divider class="my-8" />

    <h2 class="my-4" id="documentation">Le d√©tail</h2>
    <v-card
      :class="{ 'd-flex': true, 'flex-column': $vuetify.breakpoint.xs, 'align-center': $vuetify.breakpoint.xs }"
      outlined
    >
      <video
        ref="video"
        class="ma-4"
        :style="`max-width: ${$vuetify.breakpoint.xs ? '70%' : '30%'}; background: #333; border-radius: 10px`"
        poster="/static/images/video-poster-import-masse.webp"
        controls
      >
        <source
          type="video/mp4"
          src="https://cellar-c2.services.clever-cloud.com/ma-cantine-egalim/videos/Tutoriel-import-de-masse.m4v"
        />
        Votre navigateur ne peut pas afficher des vid√©os.
      </video>

      <div>
        <p class="ma-4">
          R√©gardez notre vid√©o tutorial pour repondre aux questions les plus fr√©quentes.
          <br />
          <br />
          Si vous avez toujours des questions ou des probl√®mes, n'h√©sitez pas √† nous contacter √†
          <a href="mailto:contact@egalim.beta.gouv.fr">contact@egalim.beta.gouv.fr</a>
          .
        </p>
      </div>
    </v-card>
    <h3 class="my-6">Format du fichier</h3>
    <p>
      Le fichier CSV doit √™tre encod√© avec UTF-8 et contenir un diagnostic par ligne. Chaque ligne doit aussi inclure
      les informations de la cantine associ√©e.
    </p>
    <p>Les donn√©es doivent √™tre pr√©sent√©es dans l'ordre indiqu√© ci-dessous.</p>
    <p>Si un diagnostic pour la m√™me ann√©e et la m√™me cantine existe d√©j√† il ne sera pas modifi√©.</p>
    <h4 class="my-6">Colonnes</h4>
    <v-simple-table class="my-6">
      <template v-slot:default>
        <thead>
          <tr>
            <th>Colonne</th>
            <th>Champ</th>
            <th>Description</th>
            <th>Type</th>
            <th>Exemple</th>
            <th>Obligatoire</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(field, idx) in sharedDocumentation" :key="idx">
            <td class="text-center">{{ idx + 1 }}</td>
            <td>{{ field.name }}</td>
            <td v-html="field.description"></td>
            <td>{{ field.type }}</td>
            <td style="min-width: 160px;">{{ field.example }}</td>
            <td class="text-center">{{ field.optional ? "‚úò" : "‚úî" }}</td>
          </tr>
        </tbody>
      </template>
    </v-simple-table>
    <p>
      Les champs suivants changent selon le type de diagnostic choisit. √Ä terme, seule le diagnostic complet sera
      accept√©.
    </p>
    <v-radio-group v-model="diagnosticType">
      <v-radio v-for="type in diagnosticTypes" :key="type.key" :label="type.label" :value="type.key">
        <template v-slot:label>
          <span class="grey--text text--darken-3 font-weight-bold">{{ type.label }}</span>
          <span class="body-2 ml-3">{{ type.help }}</span>
        </template>
      </v-radio>
    </v-radio-group>
    <v-simple-table class="my-2" v-if="diagnosticDocumentation.length">
      <template v-slot:default>
        <thead>
          <tr>
            <th>Colonne</th>
            <th>Champ</th>
            <th>Description</th>
            <th>Type</th>
            <th>Exemple</th>
            <th>Obligatoire</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(field, idx) in diagnosticDocumentation" :key="idx">
            <td class="text-center">{{ sharedDocumentation.length + idx + 1 }}</td>
            <td>{{ field.name }}</td>
            <td v-html="field.description"></td>
            <td>{{ field.type }}</td>
            <td>{{ field.example }}</td>
            <td class="text-center">{{ field.optional ? "‚úò" : "‚úî" }}</td>
          </tr>
        </tbody>
      </template>
    </v-simple-table>
    <p v-else>Rien d'autre colonnes requises.</p>

    <h4 class="my-6">Fichiers d'exemple</h4>
    <p>
      Nous mettons √† votre disposition un fichier exemple en format de choix :
      <a class="text-decoration-underline" :href="`${exampleFilename}.csv`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        CSV (.csv)
      </a>
      <a class="text-decoration-underline" :href="`${exampleFilename}.xlsx`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        Excel (.xlsx)
      </a>
      <a class="text-decoration-underline" :href="`${exampleFilename}.ods`" download>
        <v-icon small class="mt-n1 ml-1" color="primary">mdi-file-document-outline</v-icon>
        OpenDocument (.ods)
      </a>
      √† remplir avec vos donn√©es.
    </p>

    <h2 class="my-6" id="#contact">Vous avez besoin d'aide ?</h2>
    <p>
      Si votre fichier comptable agr√©g√© ne ressemble pas du tout √† √ßa, vous pouvez nous l'envoyer en remplissant les
      champs ci-dessous ou nous contacter directement √† l'adresse
      <a href="mailto:contact@egalim.beta.gouv.fr">contact@egalim.beta.gouv.fr</a>
      .
    </p>
    <v-form v-model="helpFormIsValid" ref="helpForm" @submit.prevent class="my-12">
      <v-row class="mb-1">
        <v-col cols="12" md="6" class="py-0">
          <v-text-field
            v-model="fromEmail"
            label="Votre email"
            :rules="[validators.email]"
            validate-on-blur
            outlined
          ></v-text-field>
        </v-col>
        <v-col class="py-0">
          <v-text-field v-model="name" label="Pr√©nom et nom" outlined></v-text-field>
        </v-col>
      </v-row>
      <v-textarea v-model="message" label="Message (facultatif)" outlined></v-textarea>
      <v-file-input
        v-model="unusualFile"
        label="Fichier"
        outlined
        :rules="[validators.required, validators.maxFileSize(10485760, '10 Mo')]"
        validate-on-blur
        show-size
      />
      <v-btn x-large color="primary" @click="emailUnusualFile">
        <v-icon class="mr-2">mdi-send</v-icon>
        Envoyer
      </v-btn>
    </v-form>
  </div>
</template>

<script>
import FileDrop from "@/components/FileDrop"
import validators from "@/validators"

export default {
  name: "ImportDiagnostics",
  components: { FileDrop },
  data() {
    const user = this.$store.state.loggedUser
    return {
      file: undefined,
      canteens: undefined,
      canteenCount: undefined,
      diagnosticCount: undefined,
      errors: undefined,
      seconds: undefined,
      importInProgress: false,
      sharedDocumentation: [
        {
          name: "SIRET de la cuisine-site",
          description: "Ce SIRET doit √™tre unique car il correspond √† un lieu physique.",
          type: "14 chiffres, avec ou sans espaces",
          example: "000 000 000 00000",
        },
        {
          name: "Nom de la cantine",
          example: "Ma Cantine",
          type: "Texte libre",
        },
        {
          name: "Code g√©ographique INSEE de la ville",
          example: "69123",
          optional: true,
        },
        {
          name: "Code postal",
          description: "En cas d'absence de code INSEE, ce champ devient obligatoire.",
          example: "69001",
          optional: true,
        },
        {
          name: "SIRET de la cantine distributrice ou SRC",
          description:
            "Ce SIRET peut √™tre vide ou utilis√© pour plusieurs lignes, dans le cas o√π c'est le gestionnaire de la SRC ou de la cuisine centrale qui remplit les lignes pour chaque cuisine-site/satellite.",
          type: "14 chiffres, avec ou sans espaces",
          example: "999 999 999 99999",
          optional: true,
        },
        {
          name: "Nombre de repas servis par jour",
          type: "Chiffre",
          example: "300",
        },
        {
          name: "Secteurs",
          description: `Options accept√©es : ${this.$store.state.sectors.map(
            (x) => " <code>" + x.name + "</code>"
          )}. Sp√©cifiez plusieurs en s√©parant avec un <code>+</code>.`,
          type: "Texte (choix unique)",
          example: `${this.$store.state.sectors[0].name}+${this.$store.state.sectors[1].name}`,
        },
        {
          name: "Mode de production",
          description:
            "Le mode de production de votre cantine. Les options :<br />- <code>central</code> si vous √™tes une cuisine centrale sans lieu de consommation<br/>- <code>central_serving</code> si vous √™tes une cuisine centrale qui accueille aussi des convives sur place,<br/>- <code>site</code> si vous √™tes une cantine qui produit les repas sur place, et<br/>- <code>site_cooked_elsewhere</code> si vous √™tes une cantine qui sert des repas prepar√©s par une cuisine centrale.<br/>",
          type: "Texte (choix unique)",
          example: "central",
        },
        {
          name: "Mode de gestion",
          description:
            "Comment le service des repas est g√©r√©. Options accept√©es : <code>direct</code> (directe) et <code>conceded</code> (conc√©d√©).",
          type: "Texte (choix unique)",
          example: "direct",
        },
        {
          name: "Secteur √©conomique",
          description:
            "Le type d'√©tablissement. Options accept√©es : <code>public</code> et <code>private</code> (priv√©).",
          type: "Texte (choix unique)",
          example: "public",
        },
        {
          name: "Gestionnaires additionnels (adresses emails)",
          description:
            "Les personnes avec ces adresses seront consid√©r√©es comme gestionnaires de la cantine et pourront modifier toutes ses donn√©es.",
          type: "Texte (adresses email s√©par√©es par une virgule)",
          example: "gestionnaire1@example.com, gestionnaire2@example.com",
          optional: true,
        },
      ],
      validators,
      helpFormIsValid: true,
      fromEmail: user ? user.email : "",
      name: user ? `${user.firstName} ${user.lastName}` : "",
      message: "",
      unusualFile: null,
      isStaff: user.isStaff,
      diagnosticTypes: [
        {
          key: "NONE",
          label: "Sans diagnostic",
          help: "Vous voulez importer des cantines sans diagnostic",
        },
        {
          key: "SIMPLE",
          label: "Diagnostic simple",
          help: "Vous connaissez les valeurs totaux, bio, et de qualit√© et durable",
        },
        {
          key: "COMPLETE",
          label: "Diagnostic complet",
          help: "Vous connaissez les labels et les familles de produits de vos achats",
        },
      ],
      diagnosticType: "SIMPLE",
    }
  },
  computed: {
    diagnosticDocumentation() {
      if (this.diagnosticType === "NONE") return []
      const numberFormatExample = "En format <code>1234</code>/<code>1234.5</code>/<code>1234.56</code>."
      const simpleValues = [
        "Valeur d'achats bio HT",
        "Valeur d'achats SIQO (hors bio) HT",
        "Valeur (en HT) de mes achats prenant en compte les co√ªts imput√©s aux externalit√©s environnementales ou acquis sur la base de leurs performances en mati√®re environnementale",
        "Valeur (en HT) des autres achats EGAlim",
        "Valeur (en HT) des mes achats en viandes et volailles fraiches ou surgel√©es total",
        "Valeur (en HT) des mes achats EGAlim en viandes et volailles fraiches ou surgel√©es",
        "Valeur (en HT) des mes achats provenance France en viandes et volailles fraiches ou surgel√©es",
        "Valeur (en HT) des mes achats en poissons et produits aquatiques total",
        "Valeur (en HT) des mes achats EGAlim en poissons et produits aquatiques",
      ]
      let valuesArray = simpleValues
      const array = [
        {
          name: "Ann√©e du diagnostic",
          description: "En format <code>YYYY</code>.",
          type: "Chiffre",
          example: "2020",
        },
        {
          name: "Valeur totale d'achats HT",
          description: numberFormatExample,
          type: "Chiffre",
          example: "1234.99",
        },
      ]
      if (this.diagnosticType === "COMPLETE") {
        valuesArray = [
          "Bio : Viandes et volailles fra√Æches et surgel√©es",
          "Bio : Produits aquatiques frais et surgel√©s",
          "Bio : Fruits et l√©gumes frais et surgel√©s",
          "Bio : Charcuterie",
          "Bio : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Bio : Boulangerie/P√¢tisserie fra√Æches",
          "Bio : Boissons",
          "Bio : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Label rouge : Viandes et volailles fra√Æches et surgel√©es",
          "Label rouge : Produits aquatiques frais et surgel√©s",
          "Label rouge : Fruits et l√©gumes frais et surgel√©s",
          "Label rouge : Charcuterie",
          "Label rouge : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Label rouge : Boulangerie/P√¢tisserie fra√Æches",
          "Label rouge : Boissons",
          "Label rouge : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "AOC / AOP / IGP / STG : Viandes et volailles fra√Æches et surgel√©es",
          "AOC / AOP / IGP / STG : Produits aquatiques frais et surgel√©s",
          "AOC / AOP / IGP / STG : Fruits et l√©gumes frais et surgel√©s",
          "AOC / AOP / IGP / STG : Charcuterie",
          "AOC / AOP / IGP / STG : BOF (Produits laitiers, beurre et ≈ìufs)",
          "AOC / AOP / IGP / STG : Boulangerie/P√¢tisserie fra√Æches",
          "AOC / AOP / IGP / STG : Boissons",
          "AOC / AOP / IGP / STG : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Certification environnementale de niveau 2 ou HVE : Viandes et volailles fra√Æches et surgel√©es",
          "Certification environnementale de niveau 2 ou HVE : Produits aquatiques frais et surgel√©s",
          "Certification environnementale de niveau 2 ou HVE : Fruits et l√©gumes frais et surgel√©s",
          "Certification environnementale de niveau 2 ou HVE : Charcuterie",
          "Certification environnementale de niveau 2 ou HVE : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Certification environnementale de niveau 2 ou HVE : Boulangerie/P√¢tisserie fra√Æches",
          "Certification environnementale de niveau 2 ou HVE : Boissons",
          "Certification environnementale de niveau 2 ou HVE : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "P√™che durable : Viandes et volailles fra√Æches et surgel√©es",
          "P√™che durable : Produits aquatiques frais et surgel√©s",
          "P√™che durable : Fruits et l√©gumes frais et surgel√©s",
          "P√™che durable : Charcuterie",
          "P√™che durable : BOF (Produits laitiers, beurre et ≈ìufs)",
          "P√™che durable : Boulangerie/P√¢tisserie fra√Æches",
          "P√™che durable : Boissons",
          "P√™che durable : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "R√©gion ultrap√©riph√©rique : Viandes et volailles fra√Æches et surgel√©es",
          "R√©gion ultrap√©riph√©rique : Produits aquatiques frais et surgel√©s",
          "R√©gion ultrap√©riph√©rique : Fruits et l√©gumes frais et surgel√©s",
          "R√©gion ultrap√©riph√©rique : Charcuterie",
          "R√©gion ultrap√©riph√©rique : BOF (Produits laitiers, beurre et ≈ìufs)",
          "R√©gion ultrap√©riph√©rique : Boulangerie/P√¢tisserie fra√Æches",
          "R√©gion ultrap√©riph√©rique : Boissons",
          "R√©gion ultrap√©riph√©rique : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Commerce √©quitable : Viandes et volailles fra√Æches et surgel√©es",
          "Commerce √©quitable : Produits aquatiques frais et surgel√©s",
          "Commerce √©quitable : Fruits et l√©gumes frais et surgel√©s",
          "Commerce √©quitable : Charcuterie",
          "Commerce √©quitable : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Commerce √©quitable : Boulangerie/P√¢tisserie fra√Æches",
          "Commerce √©quitable : Boissons",
          "Commerce √©quitable : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Fermier : Viandes et volailles fra√Æches et surgel√©es",
          "Fermier : Produits aquatiques frais et surgel√©s",
          "Fermier : Fruits et l√©gumes frais et surgel√©s",
          "Fermier : Charcuterie",
          "Fermier : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Fermier : Boulangerie/P√¢tisserie fra√Æches",
          "Fermier : Boissons",
          "Fermier : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Viandes et volailles fra√Æches et surgel√©es",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Produits aquatiques frais et surgel√©s",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Fruits et l√©gumes frais et surgel√©s",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Charcuterie",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Boulangerie/P√¢tisserie fra√Æches",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Boissons",
          "Produit prenant en compte les co√ªts imput√©s aux externalit√©s environnementales pendant son cycle de vie : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Viandes et volailles fra√Æches et surgel√©es",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Produits aquatiques frais et surgel√©s",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Fruits et l√©gumes frais et surgel√©s",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Charcuterie",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Boulangerie/P√¢tisserie fra√Æches",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Boissons",
          "Produits acquis sur la base de leurs performances en mati√®re environnementale : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Provenance France : Viandes et volailles fra√Æches et surgel√©es",
          "Provenance France : Produits aquatiques frais et surgel√©s",
          "Provenance France : Fruits et l√©gumes frais et surgel√©s",
          "Provenance France : Charcuterie",
          "Provenance France : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Provenance France : Boulangerie/P√¢tisserie fra√Æches",
          "Provenance France : Boissons",
          "Provenance France : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Circuit-court : Viandes et volailles fra√Æches et surgel√©es",
          "Circuit-court : Produits aquatiques frais et surgel√©s",
          "Circuit-court : Fruits et l√©gumes frais et surgel√©s",
          "Circuit-court : Charcuterie",
          "Circuit-court : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Circuit-court : Boulangerie/P√¢tisserie fra√Æches",
          "Circuit-court : Boissons",
          "Circuit-court : Autres produits frais, surgel√©s et d‚Äô√©picerie",
          "Produit local : Viandes et volailles fra√Æches et surgel√©es",
          "Produit local : Produits aquatiques frais et surgel√©s",
          "Produit local : Fruits et l√©gumes frais et surgel√©s",
          "Produit local : Charcuterie",
          "Produit local : BOF (Produits laitiers, beurre et ≈ìufs)",
          "Produit local : Boulangerie/P√¢tisserie fra√Æches",
          "Produit local : Boissons",
          "Produit local : Autres produits frais, surgel√©s et d‚Äô√©picerie",
        ]
      }
      valuesArray.forEach((value) => {
        array.push({
          name: value,
          description: numberFormatExample,
          type: "Chiffre",
          example: "1234.99",
          optional: this.diagnosticType === "COMPLETE",
        })
      })
      return array
    },
    exampleFilename() {
      const root = "/static/documents/"
      const filename =
        this.diagnosticType === "COMPLETE" ? "fichier_exemple_complet_ma_cantine" : "fichier_exemple_ma_cantine"
      return root + filename
    },
    importDocString() {
      return {
        SIMPLE: "l'import simple",
        COMPLETE: "l'import complet",
        NONE: "l'import de cantines seulement",
      }[this.diagnosticType]
    },
  },
  methods: {
    upload() {
      this.importInProgress = true
      this.$store
        .dispatch("importDiagnostics", { file: this.file })
        .then((json) => {
          this.importInProgress = false
          this.file = null
          this.canteens = json.canteens
          this.canteenCount = json.canteens.length
          this.diagnosticCount = json.count
          this.errors = json.errors
          this.seconds = json.seconds
          let resultMessage = {
            message: `${this.canteenCount} cantines trait√©es`,
            status: "success",
          }
          if (this.errors.length) {
            resultMessage.title = "Echec d'import"
            resultMessage.message = "Merci de v√©rifier les erreurs d√©taill√©s et de reessayer"
            resultMessage.status = "error"
          }
          this.$store.dispatch("notify", resultMessage)
          if (this.$matomo) {
            this.$matomo.trackEvent("inquiry", "send", "import-diagnostics-success")
          }
        })
        .catch((e) => {
          this.importInProgress = false
          this.$store.dispatch("notifyServerError", e)
        })
    },
    emailUnusualFile() {
      this.$refs.helpForm.validate()
      if (!this.helpFormIsValid) {
        this.$store.dispatch("notifyRequiredFieldsError")
        return
      }
      let form = new FormData()
      form.append("file", this.unusualFile)
      form.append("name", this.name)
      form.append("email", this.fromEmail)
      form.append("message", this.message)
      fetch("/api/v1/emailDiagnosticImportFile/", {
        method: "POST",
        headers: {
          "X-CSRFToken": window.CSRF_TOKEN || "",
        },
        body: form,
      })
        .then((response) => {
          if (response.ok) {
            this.$store.dispatch("notify", {
              status: "success",
              title: "Fichier envoy√©",
              message: "Merci, nous vous contacterons dans les plus brefs d√©lais.",
            })
            this.unusualFile = null
            this.message = ""
          } else {
            this.$store.dispatch("notifyServerError", response)
          }
        })
        .catch((e) => {
          this.$store.dispatch("notifyServerError", e)
        })
    },
  },
}
</script>
