<!-- api.html -->
<!-- Documentation of the API displayed in the swagger -->

<h2>Fonctionnement</h2>

<p>
Cette API permet de s'interfacer √† l'application ma-cantine afin de r√©aliser les d√©marches administratives de cantines.

Pour pouvoir envoyer les donn√©es sur notre plateforme, vous devez dans un premier temps synchroniser votre compte avec votre cantine existante sur notre plateforme. La connexion se fait via le num√©ro SIRET.
Puis l'API vous permet d'envoyer les donn√©es d'approvisionnements (par cantine) sur la plateforme ma-cantine. Vous pouvez cr√©er des nouveaux diagnostic et mettre √† jour les diagnostics d√©j√† existants.
Enfin, ces donn√©es seront affich√©es sur tableau de bord de la cantine en fonction de l'ann√©e.
</p>

<h2>Autorisation</h2>

<p>
L'API est prot√©g√© par le protocole d'autorisation OAuth2 (avec le package <a href="https://django-oauth-toolkit.readthedocs.io/en/latest/">Django OAuth Toolkit Documentation</a>). Afin d'obtenir une autorisation, il faut :
<ol>
<li>Avoir un compte de d√©v sur la plateforme <i>ma cantine</i>. Quand vous <a href="https://ma-cantine-demo.cleverapps.io/creer-mon-compte" target="_blank">cr√©ez votre compte</a>, cocher le cas "Je suis une d√©veloppeuse ou un d√©veloppeur logiciel et j'ai besoin d'acc√©der aux APIs". Si vous avez d√©j√† un compte et vous voyez pas la page de documentation API, il vous faudra cocher ce cas sur la page <a href="https://ma-cantine-demo.cleverapps.io/mon-compte/profil" target="_blank">Mon compte</a></li>
<li>Avoir <a href="https://ma-cantine-demo.cleverapps.io/o/applications/" target="_blank">enregistr√© votre application</a> sur la plateforme ma-cantine. A ce stade, il vous faut sauvegarder le CLIENT_SECRET qui ne sera plus visible ensuite (seulement la version hash√©e le sera).</li>
<li>R√©cup√©rer le code d'autorisation dans l'url (voir exemple plus bas). Ce code √† une dur√©e de vie d'une minute.</li>
<li>Utiliser ce code d'autorisation pour n√©gocier et r√©cuperer un token d'autorisation.</li>
</ol>

Vous serez ensuite autoris√© √† utiliser l'API avec vos m√™mes droits utilisateur que sur la plateforme.
</p>

<h2>Tester</h2>
<p>
<b>‚ö†Ô∏è Important :</b> Les tests se font obligatoirement sur la plateforme de <a href="https://ma-cantine-demo.cleverapps.io/" target="_blank">d√©mo</a> (la suite de la doc r√©f√©rencera toujours l'instance de d√©mo). La plateforme de <a href="https://ma-cantine.agriculture.gouv.fr">prod</a> est r√©serv√©e aux donn√©es r√©elles.

Vous pouvez utiliser ce swagger pour tester l'API ici ou consulter un <a href="https://github.com/betagouv/ma-cantine-demo-integration">exemple d'application</a> en python.
</p>

<h3> Tester ici </h3>

<p>
<ol>
<li>Cr√©er une application (comme d√©crit au dessus) avec le URI de redirection de swagger : <i>https://ma-cantine-demo.cleverapps.io/swagger-ui/oauth2-redirect.html</i> (pensez √† changer l'URL pour la production)</li>
<li>Sauvegarder le secret</li>
<li>Ici, cliquez sur le bouton vert Authorize üîì, et suivez le protocole d'autorisation dans la partie oauth2 (OAuth2, authorizationCode)" avec le client_id et client_secret de l'application que vous avez cr√©√©e. Cette √©tape va vous renvoyer vers une page 404 de l'application ma-cantine. C'est bon signe ! Vous pouvez alors r√©cup√©rer le code dans l'URL. </br>
    Exemple : <i>https://ma-cantine-demo.cleverapps.io/swagger-ui/oauth2-redirect.html/?code=<b>HRnXZzhez5WJVNzW7TgsLAbeFZOmB3</b>&state=RnJpIEp1bCAyN...</i></li>
</ol>
</p>

<h2>Gestion des erreurs</h2>

<p>
<i>En cours de r√©daction</i>
</p>
